<template>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Категории</h4>
                    </div>
                    <div class="card-body">
                        <form @submit="formSubmit" enctype="multipart/form-data">
                            <el-row :gutter="20">
                                <el-col :span="12">
                                    <div class="t-control t-box">
                                        <span class="t-box-title">Введите название сервиса</span>
                                        <el-input placeholder="Введите название сервиса"  v-model="service.title" />
                                    </div>
                                    <div class="t-control t-box">
                                        <span class="t-box-title">Краткое описание</span>
                                        <el-input
                                            type="textarea"
                                            :rows="2"
                                            placeholder="Краткое описание"
                                            v-model="service.desc">
                                        </el-input>
                                    </div>
                                </el-col>
                                <el-col :span="12">
                                    <div class="t-control t-box">
                                        <el-select v-model="service.category_id" placeholder="Выберите категорию">
                                            <el-option
                                                v-for="item in categories"
                                                :key="item.id"
                                                :label="item.title"
                                                :value="item.id">
                                            </el-option>
                                        </el-select>
                                    </div>
                                    <div class="t-control t-box">
                                        <div>
                                            <span class="demonstration">Простота использования</span>
                                            <el-rate v-model="service.assessmentUse" />
                                        </div>
                                        <div>
                                            <span class="demonstration">Обслуживания клиентов</span>
                                            <el-rate v-model="service.assessmentSupport" />
                                        </div>
                                    </div>
                                    <div class="t-control t-box">

                                    </div>
                                </el-col>
                            </el-row>

                            <div class="t-control t-box">
                                <TuiEditor
                                    mode="wysiwyg"
                                    preview-style="vertical"
                                    height="300px"
                                    v-model="service.content"
                                />
                            </div>

                            <el-row :gutter="20">
                                <el-col :span="12">
                                    <div class="t-control t-box">
                                        <span class="t-box-title">Ссылка на сайт</span>
                                        <el-input placeholder="Ссылка на сайт"  v-model="service.linkSite" />
                                    </div>
                                    <div class="t-control t-box">
                                        <span class="t-box-title">Ссылка на кейсы</span>
                                        <el-input placeholder="Ссылка на кейсы"  v-model="service.linkCases" />
                                    </div>
                                    <div class="t-control t-box">
                                        <span class="t-box-title">Ссылка на инструкции</span>
                                        <el-input placeholder="Ссылка на инструкции"  v-model="service.linkInstructions" />
                                    </div>
                                </el-col>
                                <el-col :span="12">
                                    <div class="t-control t-box">
                                        <span class="t-box-title">Ссылка на видео</span>
                                        <el-input placeholder="Ссылка на видео"  v-model="service.linkVideo" />
                                    </div>
                                    <div class="t-control t-box">
                                        <span class="t-box-title">Ссылка на API</span>
                                        <el-input placeholder="Ссылка на API"  v-model="service.linkAPI" />
                                    </div>
                                    <div class="t-control t-box">
                                        <span class="t-box-title">Метод оплаты</span>
                                        <el-input placeholder="Метод оплаты"  v-model="service.methodsPay" />
                                    </div>
                                </el-col>
                            </el-row>
                            <el-row :gutter="20">
                                <el-col :span="12">
                                    <div class="t-control t-box">
                                        <span class="t-box-title">Платформы установки</span>
                                        <el-select
                                            v-model="systemIntFormat"
                                            multiple
                                            collapse-tags
                                            style="margin-left: 20px;"
                                            placeholder="Выбрать">
                                            <el-option
                                                v-for="item in systemInstallAll"
                                                :key="item.value"
                                                :label="item.label"
                                                :value="item.value">
                                            </el-option>
                                        </el-select>
                                    </div>
                                    <div class="t-control t-box">
                                        <span class="t-box-title">Для кого</span>
                                        <el-select
                                            v-model="professions"
                                            multiple
                                            filterable
                                            allow-create
                                            default-first-option
                                            placeholder="Для кого"
                                            class="full">
                                            <el-option
                                                v-for="item in professionsOptions"
                                                :key="item.value"
                                                :label="item.label"
                                                :value="item.value">
                                            </el-option>
                                        </el-select>
                                    </div>
                                    <div class="t-control t-box">
                                        <span class="t-box-title">Для кого</span>
                                        <el-checkbox-group v-model="business">
                                            <el-checkbox label="Маленький"></el-checkbox>
                                            <el-checkbox label="Средний"></el-checkbox>
                                            <el-checkbox label="Крупный"></el-checkbox>
                                        </el-checkbox-group>
                                        <span class="t-box-title">Бизнес для:</span>
                                        <el-checkbox-group v-model="businessFor">
                                            <el-checkbox label="Бизнеса"></el-checkbox>
                                            <el-checkbox label="Потребителя"></el-checkbox>
                                        </el-checkbox-group>
                                    </div>
                                </el-col>
                                <el-col :span="12">
<!--                                    <div class="t-control t-box">-->
<!--                                        <el-select-->
<!--                                            v-model="service.socials"-->
<!--                                            multiple-->
<!--                                            filterable-->
<!--                                            allow-create-->
<!--                                            default-first-option-->
<!--                                            placeholder="Введите ссылки на соц. сети"-->
<!--                                            class="full">-->
<!--                                            <el-option-->
<!--                                                v-for="item in socialsOptions"-->
<!--                                                :key="item.value"-->
<!--                                                :label="item.label"-->
<!--                                                :value="item.value">-->
<!--                                            </el-option>-->
<!--                                        </el-select>-->
<!--                                    </div>-->
                                    <div class="t-control t-box t-box-image">
                                        <span class="t-box-title">Логотип</span>
                                        <div class="control-flex">
                                            <input type="file" v-on:change="onImageChange" class="form-control">
                                            <div class="t-box-image-cover">
                                                <img id="image" :src="urlImage + 'services/' + service.logo" alt="" />
                                            </div>
                                        </div>
                                    </div>

                                    <div class="t-control t-box">
                                        <div class="control-flex" style="align-items: initial">
                                            <div class="t-control t-box" style="flex-basis: 35%;">
                                                <span class="t-box-title">Бесплатный тариф</span>
                                                <el-checkbox v-model="freeRateCheck">
                                                    <span v-if="freeRateCheck === true">Да</span>
                                                    <span v-else>Нет</span>
                                                </el-checkbox>
                                            </div>
                                            <div class="t-control t-box">
                                                <el-collapse>
                                                    <el-collapse-item title="Пробный период" >
                                                        <div class="t-control t-box">
                                                            <span class="t-box-title">Дата</span>
                                                            <el-input placeholder="Укажите дату"  v-model="service.testPeriodDate" />
                                                        </div>
                                                        <div class="t-control t-box">
                                                            <span class="t-box-title">Ссылка на пробный период</span>
                                                            <el-input placeholder="Ссылка"  v-model="service.testPeriodLink" />
                                                        </div>
                                                    </el-collapse-item>
                                                </el-collapse>
                                            </div>
                                        </div>
                                    </div>
                                </el-col>
                            </el-row>
                            <el-row :gutter="20">
                                <el-col :span="24">
                                    <el-collapse>
                                        <el-collapse-item title="Особенности и возможности сервиса" >
                                            <el-button icon="el-icon-plus" circle  @click="addFeatures"></el-button>
                                            <div class="edit-features">
                                                <div v-for="item in service.features" class="features-item">
                                                    <div>
                                                        <div class="t-control t-box">
                                                            <span class="t-box-title">Название</span>
                                                            <el-input v-model="item.title" />
                                                        </div>
                                                        <div class="t-control t-box">
                                                            <span class="t-box-title">Cписок возможностей</span>
                                                            <el-select
                                                                v-model="item.list"
                                                                multiple
                                                                filterable
                                                                allow-create
                                                                default-first-option
                                                                placeholder="Добавьте список"
                                                                class="t-select many">
                                                            </el-select>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div class="t-control t-box">
                                                            <span class="t-box-title">Описание возможностей</span>
                                                            <el-input
                                                                type="textarea"
                                                                :rows="2"
                                                                :autosize="{ minRows: 2, maxRows: 6}"
                                                                v-model="item.desc">
                                                            </el-input>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </el-collapse-item>
                                    </el-collapse>

                                </el-col>
                            </el-row>
                            <div class="t-control">
                                <!--                            <el-button type="success" plain @click="saveService">Сохранить</el-button>-->
                                <button class="btn btn-success">Сохранить</button>
                            </div>
                        </form>
                        <div class="form-output" v-if="output">
                            {{output}}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
    const baseUrlUploads = process.env.baseUrlImage;
    import axios from "axios";
    export default {
        layout: 'admin',
        name: "serviceEdit",
        data(){
            return {
                loading: true,
                service: [],
                urlImage: baseUrlUploads,
                systemIntFormat: [],
                professions: [],
                professionsOptions: [],
                business: [],
                businessFor: [],
                freeRateCheck: false,

                output: ''
            }
        },
        methods: {
            formSubmit(e) {

                e.preventDefault();
                this.freeRateCheck === true ? this.service.freeRate = 'true' : this.service.freeRate = 'false';

                let currentObj = this;
                const config = {
                    headers: { 'content-type': 'multipart/form-data' }
                }
                let formData = new FormData();
                formData.append('logo', this.service.logo);
                formData.append('title', this.service.title);
                formData.append('desc', this.service.desc);
                formData.append('content', this.service.content);
                formData.append('category_id', this.service.category_id);
                formData.append('assessmentUse', this.service.assessmentUse);
                formData.append('assessmentSupport', this.service.assessmentSupport);
                formData.append('linkSite', this.service.linkSite);
                formData.append('linkCases', this.service.linkCases);
                formData.append('linkInstructions', this.service.linkInstructions);
                formData.append('linkVideo', this.service.linkVideo);
                formData.append('linkAPI', this.service.linkAPI);
                formData.append('methodsPay', this.service.methodsPay);
                formData.append('systemInstall', this.systemIntFormat);
                formData.append('professions', this.professions);
                formData.append('business', this.business);
                formData.append('businessFor', this.businessFor);
                formData.append('socials', this.service.socials);
                formData.append('features', JSON.stringify(this.service.features));
                formData.append('freeRate', this.service.freeRate);
                formData.append('testPeriodDate', this.service.testPeriodDate);
                formData.append('testPeriodLink', this.service.testPeriodLink);

                let uri = process.env.baseUrl + `services/${this.$route.params.id}`;
                axios.post(uri,formData, config)
                    .then(function (response) {
                        currentObj.output = response.data;
                    })
                    .catch(function (error) {
                        currentObj.output = error;
                    });
            },
            onImageChange(e){
                this.service.logo = e.target.files[0];
                this.readUrlImage(e.target)
            },
            readUrlImage(input){
                if (input.files && input.files[0]) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        document.getElementById('image').setAttribute('src', e.target.result);
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },
            formationSystem(val){
                if(val){
                    for (let i=0; i<val.length; i++) {
                        if(!isNaN(Number(val[i]))){
                            this.systemIntFormat.push(val[i]);
                        }
                    }
                }
            },
            formationProfessions(str){
                if(str){
                    let mas = [],
                        j = 0;
                    for (let i = 0; i < str.length; i++) {
                        if (str[i] == ",") { j++; continue; }
                        else {
                            mas[j] ? mas[j] += str[i] : mas[j] = str[i];
                        }
                    }
                    this.professions = mas;
                }
            },
            formationBusiness(str, type){
                if(str){
                    let mas = [],
                        j = 0;
                    for (let i = 0; i < str.length; i++) {
                        if (str[i] == ",") { j++; continue; }
                        else {
                            mas[j] ? mas[j] += str[i] : mas[j] = str[i];
                        }
                    }
                    type === 'businessFor' ? this.businessFor = mas : this.business = mas;
                }
            },
            addFeatures(){
                let currentLength = this.service.features.length + 1;
                this.service.features.push({id: currentLength, title: '', list: [], desc: ''})
            },
        },
        mounted() {
            if(this.$route.params.id){
                let uri = process.env.baseUrl + `services/${this.$route.params.id}`;
                axios.get(uri).then((response) => {
                    this.service = response.data;

                    response.data.freeRate === 'true' ? this.freeRateCheck = true : this.freeRateCheck = false

                    this.formationBusiness(response.data.business, 'business');
                    this.formationBusiness(response.data.businessFor, 'businessFor');

                    this.formationSystem(response.data.systemInstall);
                    this.formationProfessions(response.data.professions);

                    this.loading = false;
                });
            }
        },
        computed: {
            categories() {
                return this.$store.state.data.category.categories;
            },
            systemInstallAll() {
                return this.$store.state.data.others.systemInstall;
            }
        }
    }
</script>

<style scoped>

</style>
