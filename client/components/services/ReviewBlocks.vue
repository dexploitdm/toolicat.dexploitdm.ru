<template>
    <div class="services-reviews">
        {{reviews}}
        <div class="assessment-pages">

            <div class="reviews-element--container">
                <div class="container">

                    <div v-for="item in reviews"
                         class="reviews-el">
                        <div class="left-box">
                            <div class="top-box">
                                <div class="img-box">
                                    <img src="/images/user.png" alt="">
                                </div>
                                <div class="text-box">
                                    <h3>
                                        {{userName(item.user_id)}}
                                    </h3>
                                    <p>
                                        {{userProfession(item.user_id)}}
                                    </p>
                                    <a href="">{{userName(item.user_id)}}</a>
<!--                                    <a href="" class="facebook">Travis A</a>-->

                                </div>
                            </div>
                            <div class="bottom-box">
                                <p>21.11.2019</p>
                                <div class="star-box">
                                    <div class="services-assessment-box_item">
                                        <div class="services-assessment-title">
                                            Простота использования
                                        </div>
                                        <div class="services-assessment-stars">
                                            <el-rate
                                                v-model="item.rating_use"
                                                :colors="colors">
                                            </el-rate>
                                            <span class="services-assessment-text"> {{item.rating_use}}/5</span>
                                        </div>
                                    </div>
                                    <div  class="services-assessment-box_item">
                                        <div  class="services-assessment-title">
                                            Поддержка
                                        </div>
                                        <div  class="services-assessment-stars">
                                            <el-rate
                                                v-model="item.rating_support"
                                                :colors="colors">
                                            </el-rate>
                                            <span class="services-assessment-text"> {{item.rating_support}}/5</span>
                                        </div>
                                    </div>
                                    <div  class="services-assessment-box_item">
                                        <div  class="services-assessment-title">
                                            Соответствие цены качеству
                                        </div>
                                        <div  class="services-assessment-stars">
                                            <el-rate
                                                v-model="item.rating_quality"
                                                :colors="colors">
                                            </el-rate>
                                            <span  class="services-assessment-text"> {{item.rating_quality}}/5</span></div>
                                    </div>
                                    <div  class="services-assessment-box_item">
                                        <div  class="services-assessment-title">
                                            Возможности
                                        </div>
                                        <div  class="services-assessment-stars">
                                            <el-rate
                                                v-model="item.rating_features"
                                                :colors="colors">
                                            </el-rate>
                                            <span class="services-assessment-text"> {{item.rating_features}}/5</span>
                                        </div>
                                    </div>
                                    <div  class="services-assessment-box_item">
                                        <div  class="services-assessment-title">
                                            Вероятность что буду рекомендовать
                                        </div>
                                        <div  class="services-assessment-stars">
                                            <el-rate
                                                v-model="item.rating_recommendation"
                                                :colors="colors">
                                            </el-rate>
                                            <span  class="services-assessment-text"> {{item.rating_recommendation}}/5</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="right-box">
                            <div class="text-box">
                                <div class="text-el">
                                    <h6>Плюсы:</h6>
                                    <p>{{item.comment_plus}}</p>
                                </div>
                                <div class="text-el">
                                    <h6>Минусы:</h6>
                                    <p>{{item.comment_minus}}</p>
                                </div>
                                <div class="text-el">
                                    <h6>В целом:</h6>
                                    <p>{{item.comment_all}}</p>
                                </div>
                                <div class="bottom-menu" :id="'likeblock_' + item.id">
                                    <span class="arrow-bottom" @click="triggerLike(item, 'dislike')"></span>
                                    <p class="green" @click="openLikes(item)">{{item.like_r}}</p>
                                    <span class="arrow-top" @click="triggerLike(item, 'like')"></span>
                                    <ul :id="'listlikes_' + item.id">
                                        <li>
                                            <img src="/images/user.png" alt="">
                                            <p>Максим Мостовой</p>
                                        </li>
                                        <li>
                                            <img src="/images/32.jpg" alt="">
                                            <p>Андрей Андреевич</p>
                                        </li>
                                        <li>
                                            <img src="/images/user.png" alt="">
                                            <p>Максим Мостовой</p>
                                        </li>
                                        <li>
                                            <img src="/images/32.jpg" alt="">
                                            <p>Андрей Андреевич</p>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>


<!--                    <div class="update-box-content">-->
<!--                        <div class="text-box">-->
<!--                            <h6>Обновление на  vc.ru</h6>-->
<!--                            <h5>Налоговая безопасность среднего бизнеса в 2020 году.</h5>-->
<!--                            <h5>Большой семинар «Остаться в живых»</h5>-->
<!--                            <div class="bottom-box">-->
<!--                                <p>12 декабря</p>-->
<!--                                <p>Екатеринбург</p>-->
<!--                                <p>19 900 ₽</p>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                        <a href="#">Узнать</a>-->
<!--                    </div>-->


                </div>
            </div>


        </div>
    </div>
</template>

<script>
    import axios from "axios";
    const baseUrlUploads = process.env.baseUrlImage;
    export default {
        name: "ReviewBlocks",
        data(){
            return{
                urlImage: baseUrlUploads,
                colors: ['#99A9BF', '#F7BA2A', '#FF9900'],
                listActive: false,
                stateRunLike: true
            }
        },
        methods: {
            triggerLike: function (item, type) {

                let itemLike = item.like_r;
                let userLikes = item.like_users;
                let listUsers = this.formationArray(userLikes);

                let resultListLikes = ''

                let currentUserID = this.usersAuth.id;
                let isListUser
                if(listUsers){
                    isListUser = listUsers.find((item) => {if (Number(item) === currentUserID) {return true}});
                }

                if (this.usersAuth && this.stateRunLike) {

                    if(type === 'like'){
                        if(!isListUser){
                            //Если позьзователь не ставил лайк
                            console.log(' like up ')
                            itemLike++

                            //TODO: Корректное формирование ","
                            if(userLikes && userLikes.length > 0){
                                resultListLikes = userLikes + ',' + currentUserID;
                            } else {
                                //Если  лист чистый
                                resultListLikes = currentUserID;
                            }

                        } else {
                            //Перезаписываем лист
                            resultListLikes = userLikes;
                        }
                    } else {
                        // TODO: Если человек человек ставил лайк
                        if(isListUser){
                            itemLike--
                            let formatList = [];
                            for (let i = 0; i < listUsers.length; i++) {
                                if(listUsers[i] !== isListUser){
                                    formatList.push(listUsers[i])
                                }
                            }
                            resultListLikes = formatList;
                        }
                    }

                    let formData = new FormData();
                    formData.append('like_r', itemLike);
                    formData.append('like_users', resultListLikes);
                    let uri = process.env.baseUrl + `reviews/${item.id}`;
                    axios.post(uri, formData)
                        .then(function (response) {
                        })
                    this.$store.dispatch('data/reviews/GET_REVIEWS_SERVICE', this.$route.params.id);
                    this.$store.dispatch('data/reviews/GET_REVIEWS_SERVICE', this.$route.params.id);
                    this.stateRunLike = false;
                } else {
                    this.$notify({title: 'Предупреждение', message: 'Сперва авторизуйтесь!', type: 'warning'});
                }
            },
            openLikes(item){
                const likeBlock = document.getElementById('likeblock_'+ item.id);
                const list = document.getElementById('listlikes_'+ item.id);
                likeBlock.classList.toggle('is-active');

                let listUser = '';
                let listUsers = this.formationArray(item.like_users);

                if(listUsers){
                    for (let i = 0; i < listUsers.length; i++) {
                        let thisUser = this.targetUser(Number(listUsers[i]))
                        let fullName = this.formatListLikes(thisUser)
                        listUser+= fullName;
                    }
                }
                list.innerHTML = listUser
            },

            formatListLikes(user){
                if(user){
                    let result = '';
                    let name = '';
                    let surname = ''
                    let logo = '';

                    if(user.surname){
                        surname = user.surname;
                    }
                    name = user.name;
                    if(surname){
                        let isFullName = this.getSpacesCount(user.name);
                        if(isFullName === 1){
                            surname = '';
                        }
                    }
                    if(user.logo){
                        logo = this.urlImage+ 'users/' + user.logo;
                    } else {
                        logo = '/images/user.png';
                    }
                    result = '<li><img src="' + logo + '" alt=""> <p>' + name + ' ' + surname + '</p></li>'
                    return result;
                }
            },
            getSpacesCount(str) {
                let cntr = 0;
                for (let i = 0, len = str.length; i < len;i++)
                    cntr += str.charAt(i) === " " ? 1 : 0;
                return cntr;
            },
            userName(id){
                let strName = '';
                let name = '';
                let strSurName = '';
                let current = this.targetUser(id);
                if(current){
                    if(current.surname){
                        strSurName = current.surname[0] + '.'
                    }
                    name = current.name;
                }
                strName+= name + ' ' + strSurName;
                return strName;
            },
            userProfession(id){
                let result = '';
                let current = this.targetUser(id);
                if(current){
                    result = current.profession;
                }
                return result;
            },
            targetUser(userID){
                return this.users.find((item) => {
                    if (item.id === userID) {
                        return true
                    }
                })
            },
            formationArray(str){
                if(str){
                    let mas = [],
                        j = 0;
                    for (let i = 0; i < str.length; i++) {
                        if (str[i] == ",") { j++; continue; }
                        else {
                            mas[j] ? mas[j] += str[i] : mas[j] = str[i];
                        }
                    }
                    return mas;
                }
            },
        },
        watch: {
            reviews(){
                this.stateRunLike = true;
            }
        },
        computed: {
            reviews() {
                return this.$store.state.data.reviews.reviews;
            },
            users() {
                return this.$store.state.data.users.users;
            },
            usersAuth() {
                return this.$store.state.auth.user;
            }
        }
    }
</script>

<style scoped>

</style>
