<template>
    <div class="services-reviews">
        {{reviews}}
        <div class="assessment-pages">

            <div class="reviews-element--container">
                <div class="container">

                    <div v-for="item in reviews"
                         class="reviews-el">
                        <div class="left-box">
                            <div class="top-box">
                                <div class="img-box">
                                    <img src="/images/user.png" alt="">
                                </div>
                                <div class="text-box">
                                    <h3>
                                        {{userName(item.user_id)}}
                                    </h3>
                                    <p>
                                        {{userProfession(item.user_id)}}
                                    </p>
                                    <a href="">{{userName(item.user_id)}}</a>
<!--                                    <a href="" class="facebook">Travis A</a>-->

                                </div>
                            </div>
                            <div class="bottom-box">
                                <p>21.11.2019</p>
                                <div class="star-box">
                                    <div class="services-assessment-box_item">
                                        <div class="services-assessment-title">
                                            Простота использования
                                        </div>
                                        <div class="services-assessment-stars">
                                            <el-rate
                                                v-model="item.rating_use"
                                                :colors="colors">
                                            </el-rate>
                                            <span class="services-assessment-text"> {{item.rating_use}}/5</span>
                                        </div>
                                    </div>
                                    <div  class="services-assessment-box_item">
                                        <div  class="services-assessment-title">
                                            Поддержка
                                        </div>
                                        <div  class="services-assessment-stars">
                                            <el-rate
                                                v-model="item.rating_support"
                                                :colors="colors">
                                            </el-rate>
                                            <span class="services-assessment-text"> {{item.rating_support}}/5</span>
                                        </div>
                                    </div>
                                    <div  class="services-assessment-box_item">
                                        <div  class="services-assessment-title">
                                            Соответствие цены качеству
                                        </div>
                                        <div  class="services-assessment-stars">
                                            <el-rate
                                                v-model="item.rating_quality"
                                                :colors="colors">
                                            </el-rate>
                                            <span  class="services-assessment-text"> {{item.rating_quality}}/5</span></div>
                                    </div>
                                    <div  class="services-assessment-box_item">
                                        <div  class="services-assessment-title">
                                            Возможности
                                        </div>
                                        <div  class="services-assessment-stars">
                                            <el-rate
                                                v-model="item.rating_features"
                                                :colors="colors">
                                            </el-rate>
                                            <span class="services-assessment-text"> {{item.rating_features}}/5</span>
                                        </div>
                                    </div>
                                    <div  class="services-assessment-box_item">
                                        <div  class="services-assessment-title">
                                            Вероятность что буду рекомендовать
                                        </div>
                                        <div  class="services-assessment-stars">
                                            <el-rate
                                                v-model="item.rating_recommendation"
                                                :colors="colors">
                                            </el-rate>
                                            <span  class="services-assessment-text"> {{item.rating_recommendation}}/5</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="right-box">
                            <div class="text-box">
                                <div class="text-el">
                                    <h6>Плюсы:</h6>
                                    <p>{{item.comment_plus}}</p>
                                </div>
                                <div class="text-el">
                                    <h6>Минусы:</h6>
                                    <p>{{item.comment_minus}}</p>
                                </div>
                                <div class="text-el">
                                    <h6>В целом:</h6>
                                    <p>{{item.comment_all}}</p>
                                </div>
                                <div class="bottom-menu" :id="'likeblock_' + item.id" @click="openLikes(item.id)">
                                    <span class="arrow-bottom" @click="triggerLike(item, 'dislike')"></span>
                                    <p class="green">{{item.like_r}}</p>
                                    <span class="arrow-top" @click="triggerLike(item, 'like')"></span>
                                    <ul>
                                        <li>
                                            <img src="/images/user.png" alt="">
                                            <p>Максим Мостовой</p>
                                        </li>
                                        <li>
                                            <img src="/images/32.jpg" alt="">
                                            <p>Андрей Андреевич</p>
                                        </li>
                                        <li>
                                            <img src="/images/user.png" alt="">
                                            <p>Максим Мостовой</p>
                                        </li>
                                        <li>
                                            <img src="/images/32.jpg" alt="">
                                            <p>Андрей Андреевич</p>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>


<!--                    <div class="update-box-content">-->
<!--                        <div class="text-box">-->
<!--                            <h6>Обновление на  vc.ru</h6>-->
<!--                            <h5>Налоговая безопасность среднего бизнеса в 2020 году.</h5>-->
<!--                            <h5>Большой семинар «Остаться в живых»</h5>-->
<!--                            <div class="bottom-box">-->
<!--                                <p>12 декабря</p>-->
<!--                                <p>Екатеринбург</p>-->
<!--                                <p>19 900 ₽</p>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                        <a href="#">Узнать</a>-->
<!--                    </div>-->


                </div>
            </div>


        </div>
    </div>
</template>

<script>
    import axios from "axios";
    export default {
        name: "ReviewBlocks",
        data(){
            return{
                colors: ['#99A9BF', '#F7BA2A', '#FF9900'],
                listActive: false,
                stateRunLike: true
            }
        },
        methods: {
            triggerLike: function (item, type) {

                let itemLike = item.like_r;
                let userLikes = item.like_users;
                let listUsers = this.formationArray(userLikes);

                let resultListLikes = ''

                let currentUserID = this.usersAuth.id;
                let isListUser
                if(listUsers){
                    isListUser = listUsers.find((item) => {if (item === currentUserID) {return true}});
                }


                console.log(isListUser)

                if (this.usersAuth && this.stateRunLike) {

                    if(type === 'like'){
                        //TODO: Сделать проверку userLikes



                        if(!isListUser){
                            //TODO: Если позьзователь не лайкал
                            console.log(' like up ')
                            itemLike++
                            resultListLikes = currentUserID;
                        }

                        // console.log(listUsers + ' listUsers')
                        // console.log(currentUserID + ' currentUserID')




                        //itemLike++
                    } else {
                        // TODO: Если человек есть в системе
                        //itemLike--
                    }



                    let formData = new FormData();
                    formData.append('like_r', itemLike);
                    formData.append('like_users', resultListLikes);

                    console.log('push------------------------')
                    console.log(itemLike)
                    console.log(resultListLikes)
                    console.log('push------------------------')

                    let uri = process.env.baseUrl + `reviews/${item.id}`;
                    axios.post(uri, formData)
                        .then(function (response) {
                        })
                    this.$store.dispatch('data/reviews/GET_REVIEWS_SERVICE', this.$route.params.id);
                    this.$store.dispatch('data/reviews/GET_REVIEWS_SERVICE', this.$route.params.id);
                    this.stateRunLike = false;
                } else {
                    this.$notify({title: 'Предупреждение', message: 'Сперва авторизуйтесь!', type: 'warning'});
                }


            },
            openLikes(id){
                const likeBlock = document.getElementById('likeblock_'+ id);
                likeBlock.classList.toggle('is-active');
            },
            userName(id){
                let strName = '';
                let current = this.targetUser(id);
                console.log(current)
                if(current){
                    strName+= current.name + ' ' +current.surname[0] + '.';
                }
                return strName;
            },
            userProfession(id){
                let result = '';
                let current = this.targetUser(id);
                if(current){
                    result = current.profession;
                }
                return result;
            },
            targetUser(userID){
                return this.users.find((item) => {
                    if (item.id === userID) {
                        return true
                    }
                })
            },
            formationArray(str){
                if(str){
                    let mas = [],
                        j = 0;
                    for (let i = 0; i < str.length; i++) {
                        if (str[i] == ",") { j++; continue; }
                        else {
                            mas[j] ? mas[j] += str[i] : mas[j] = str[i];
                        }
                    }
                    return mas;
                }
            },
        },
        watch: {
            reviews(){
                console.log('изменено')
                this.stateRunLike = true;
                console.log('yes');
            }
        },
        computed: {
            reviews() {
                return this.$store.state.data.reviews.reviews;
            },
            users() {
                return this.$store.state.data.users.users;
            },
            usersAuth() {
                return this.$store.state.auth.user;
            }
        }
    }
</script>

<style scoped>

</style>
